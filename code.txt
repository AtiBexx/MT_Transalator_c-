#include <ctranslate2/translator.h>
#include "sentencepiece_processor.h"
#include <iostream>
#include <fstream>
#include <string>
#include <vector>

using namespace std;

bool saveToFile = false;
string outputFile = "translations.txt";

// Globális SentencePiece processzorok
sentencepiece::SentencePieceProcessor sp_en;
sentencepiece::SentencePieceProcessor sp_hu;

void translateLoop(ctranslate2::Translator& translator, sentencepiece::SentencePieceProcessor& sp_source, sentencepiece::SentencePieceProcessor& sp_target) {
    cout << "\nFordító mód. Írj annyi mondatot, amennyit szeretnél.\n";
    cout << "Üres sor → kihagyás, /back → vissza a főmenübe\n";

    string line;
    while (true) {
        getline(cin, line);

        if (line == "/back") break;
        if (line.empty()) continue;

        // 1. Tokenizálás SentencePiece-szel
        vector<string> tokens;
        auto status = sp_source.Encode(line, &tokens);

        if (!status.ok()) {
            cerr << "Tokenizálási hiba!" << endl;
            continue;
        }

        // FONTOS JAVÍTÁS: Hozzáadjuk a mondat vége jelet (</s>), ha a modell igényli.
        // A MarianMT modellek gyakran elvárják ezt, különben nem tudják, hol a vége,
        // és ismétlődő szemetet generálnak.
        tokens.push_back("</s>");

        if (tokens.empty()) continue;

        // 2. Fordítás (CTranslate2)
        vector<vector<string>> input = {tokens};

        try {
            ctranslate2::TranslationOptions options;
            options.beam_size = 2;
            options.max_decoding_length = 200;

            // Repetition penalty beállítása, hogy elkerüljük a szóismétlést
            options.repetition_penalty = 1.2;

            auto results = translator.translate_batch(input, options);

            // 3. Detokenizálás (SentencePiece)
            string out;
            sp_target.Decode(results[0].output(), &out);

            cout << line << " → " << out << endl;

            if (saveToFile) {
                ofstream f(outputFile, ios::app);
                if (f.is_open()) {
                    f << line << " → " << out << "\n";
                    f.close();
                }
            }
        } catch (const std::exception& e) {
            cerr << "Hiba a fordítás során: " << e.what() << endl;
        }
    }
}

int main() {
    #ifdef _WIN32
    system("chcp 65001 > nul");
    #endif

    // 1. SentencePiece modellek betöltése
    string en_spm_path = R"(E:\CodeBlocks\modellLLM\ct2\test\en-hu-f32\source.spm)";
    string hu_spm_path = R"(E:\CodeBlocks\modellLLM\ct2\test\hu-en-f32\source.spm)";

    cout << "SentencePiece modellek betöltése..." << endl;

    ifstream f_en(en_spm_path);
    if (!f_en.good()) {
        cerr << "HIBA: Nem található a SentencePiece modellfájl: " << en_spm_path << endl;
        return 1;
    }

    const auto status_en = sp_en.Load(en_spm_path);
    if (!status_en.ok()) {
        cerr << "Hiba az angol SP modell betöltésekor." << endl;
        return 1;
    }

    ifstream f_hu(hu_spm_path);
    if (f_hu.good()) {
        sp_hu.Load(hu_spm_path);
    } else {
        cout << "Figyelem: Magyar SP modell nem található, az angolt használjuk." << endl;
        sp_hu.Load(en_spm_path);
    }

    cout << "SentencePiece modellek sikeresen betöltve.\n";

    // 2. CTranslate2 modellek betöltése
    ctranslate2::models::ModelLoader enhu_loader(R"(E:\CodeBlocks\modellLLM\ct2\test\en-hu-f32)");
    ctranslate2::models::ModelLoader huen_loader(R"(E:\CodeBlocks\modellLLM\ct2\test\hu-en-f32)");

    ctranslate2::Translator enhu(enhu_loader);
    ctranslate2::Translator huen(huen_loader);
    cout << "Fordító modellek sikeresen betöltve.\n";

    while (true) {
        cout << "\n--- FŐMENÜ ---\n";
        cout << "1. EN → HU\n";
        cout << "2. HU → EN\n";
        cout << "3. Fájlba mentés (ON/OFF)\n";
        cout << "4. Kilépés\n";
        cout << "Választás: ";

        string choice;
        getline(cin, choice);

        if (choice == "1") {
            translateLoop(enhu, sp_en, sp_hu);
        }
        else if (choice == "2") {
            translateLoop(huen, sp_hu, sp_en);
        }
        else if (choice == "3") {
            saveToFile = !saveToFile;
            cout << "Fájlba mentés: " << (saveToFile ? "BE" : "KI") << endl;
        }
        else if (choice == "4") {
            cout << "Kilépés...\n";
            break;
        }
    }

    return 0;
}